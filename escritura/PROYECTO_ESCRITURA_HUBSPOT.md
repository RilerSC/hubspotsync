# üì§ HubSpot Sync - M√≥dulo de Escritura (SQL ‚Üí HubSpot)

## üìã Descripci√≥n del Proyecto

Sistema de sincronizaci√≥n inversa que toma datos desde SQL Server y los actualiza/inserta en HubSpot CRM. Este m√≥dulo complementa el sistema de extracci√≥n existente, permitiendo una sincronizaci√≥n bidireccional completa entre la base de datos corporativa y HubSpot.

## üéØ Objetivos

### Objetivo Principal
Crear un sistema robusto y eficiente para enviar actualizaciones desde SQL Server hacia HubSpot, manteniendo la integridad de datos y optimizando el rendimiento.

### Objetivos Espec√≠ficos
- ‚úÖ **Lectura optimizada** de datos desde SQL Server
- ‚úÖ **Mapeo inteligente** de campos SQL ‚Üî HubSpot
- ‚úÖ **Detecci√≥n autom√°tica** de registros nuevos vs existentes
- ‚úÖ **Operaciones masivas** (batch operations) para eficiencia
- ‚úÖ **Manejo de errores** y reintentos autom√°ticos
- ‚úÖ **Logging detallado** de todas las operaciones
- ‚úÖ **Validaci√≥n de datos** antes del env√≠o

## üèóÔ∏è Arquitectura del Sistema

### Componentes Principales

```
üìÅ escritura/
‚îú‚îÄ‚îÄ üìÑ write_contacts.py       # M√≥dulo principal de escritura de contactos
‚îú‚îÄ‚îÄ üìÑ sql_reader.py           # Lector optimizado de SQL Server
‚îú‚îÄ‚îÄ üìÑ hubspot_writer.py       # Escritor especializado para HubSpot API
‚îú‚îÄ‚îÄ üìÑ field_mapper.py         # Mapeo de campos SQL ‚Üî HubSpot
‚îú‚îÄ‚îÄ üìÑ data_validator.py       # Validador de datos y reglas de negocio
‚îú‚îÄ‚îÄ üìÑ batch_processor.py      # Procesador de lotes y operaciones masivas
‚îú‚îÄ‚îÄ üìÑ error_handler.py        # Manejo centralizado de errores
‚îú‚îÄ‚îÄ üìÑ sync_logger.py          # Sistema de logging especializado
‚îî‚îÄ‚îÄ üìÑ config.yaml             # Configuraci√≥n de mapeos y reglas
```

### Flujo de Datos

```mermaid
graph TD
    A[SQL Server] --> B[sql_reader.py]
    B --> C[field_mapper.py]
    C --> D[data_validator.py]
    D --> E[batch_processor.py]
    E --> F[hubspot_writer.py]
    F --> G[HubSpot API]
    
    H[error_handler.py] --> E
    I[sync_logger.py] --> F
```

## üìä Casos de Uso

### üîë Criterio de Validaci√≥n √önico: N√∫mero de C√©dula
**IMPORTANTE**: El sistema utilizar√° exclusivamente el campo `no__de_cedula` como identificador √∫nico para determinar si un contacto existe en HubSpot o debe ser creado.

### 1. Actualizaci√≥n de Contactos Existentes
- **Escenario**: Contacto con c√©dula X existe en HubSpot
- **Validaci√≥n**: B√∫squeda en HubSpot por `no__de_cedula`
- **Acci√≥n**: UPDATE en HubSpot con todos los datos actualizados de SQL
- **API**: `PUT /crm/v3/objects/contacts/{contactId}`

### 2. Inserci√≥n de Contactos Nuevos  
- **Escenario**: Contacto con c√©dula X NO existe en HubSpot
- **Validaci√≥n**: B√∫squeda en HubSpot por `no__de_cedula` retorna 404
- **Acci√≥n**: INSERT en HubSpot con datos completos de SQL
- **API**: `POST /crm/v3/objects/contacts`

### 3. Sincronizaci√≥n Masiva
- **Escenario**: Migraci√≥n inicial o sincronizaci√≥n completa
- **Estrategia**: Por cada registro de SQL, verificar existencia por c√©dula
- **Optimizaci√≥n**: Batch de b√∫squedas y operaciones agrupadas
- **API**: `POST /crm/v3/objects/contacts/batch/read` ‚Üí `POST /crm/v3/objects/contacts/batch/update` o `POST /crm/v3/objects/contacts/batch/create`

## üó∫Ô∏è Mapeo de Campos

### Campos Cr√≠ticos de Contactos

| Campo SQL | Campo HubSpot | Tipo | Requerido | Validaci√≥n |
|-----------|---------------|------|-----------|------------|
| `numero_asociado` | `numero_asociado` | text | ‚úÖ | Formato espec√≠fico |
| `no__de_cedula` | `no__de_cedula` | text | ‚úÖ | Validaci√≥n c√©dula CR |
| `firstname` | `firstname` | text | ‚úÖ | No vac√≠o |
| `lastname` | `lastname` | text | ‚úÖ | No vac√≠o |
| `email` | `email` | email | ‚úÖ | Formato email v√°lido |
| `hs_whatsapp_phone_number` | `hs_whatsapp_phone_number` | phone | ‚ùå | Formato tel√©fono |
| `telefono_habitacion` | `telefono_habitacion` | phone | ‚ùå | Formato tel√©fono |
| `telefono_oficina` | `telefono_oficina` | phone | ‚ùå | Formato tel√©fono |
| `date_of_birth` | `date_of_birth` | date | ‚ùå | Formato ISO |
| `marital_status` | `marital_status` | enumeration | ‚ùå | Valores predefinidos |
| `provincia` | `provincia` | text | ‚ùå | Lista v√°lida |
| `canton` | `canton` | text | ‚ùå | Lista v√°lida |
| `distrito` | `distrito` | text | ‚ùå | Lista v√°lida |

### Campos Financieros

| Campo SQL | Campo HubSpot | Tipo | Validaci√≥n |
|-----------|---------------|------|------------|
| `salario_neto_semanal_o_quincenal` | `salario_neto_semanal_o_quincenal` | number | Valor positivo |
| `salario_bruto_semanal_o_quincenal` | `salario_bruto_semanal_o_quincenal` | number | Valor positivo |
| `frecuencia_deposito_de_su_salario` | `frecuencia_deposito_de_su_salario` | enumeration | Valores v√°lidos |

### Campos de Beneficiarios

| Campo SQL | Campo HubSpot | Tipo | Validaci√≥n |
|-----------|---------------|------|------------|
| `nombre_y_apellidos__beneficiario_01_` | `nombre_y_apellidos__beneficiario_01_` | text | Formato nombre |
| `numero_de_cedula__beneficiario_1_` | `numero_de_cedula__beneficiario_1_` | text | Formato c√©dula |
| `porcentaje__beneficiario_1_` | `porcentaje__beneficiario_1_` | number | 0-100% |

## üîÑ Estrategias de Sincronizaci√≥n

### üîë Estrategia Principal: Validaci√≥n por N√∫mero de C√©dula

```python
# Algoritmo principal de sincronizaci√≥n
def sync_contact_by_cedula(sql_record):
    cedula = sql_record['no__de_cedula']
    
    # 1. Buscar contacto existente en HubSpot por c√©dula
    existing_contact = hubspot_api.search_contact_by_cedula(cedula)
    
    if existing_contact:
        # 2a. ACTUALIZAR: Contacto existe
        return hubspot_api.update_contact(existing_contact.id, sql_record)
    else:
        # 2b. INSERTAR: Contacto no existe
        return hubspot_api.create_contact(sql_record)
```

### 1. Sincronizaci√≥n Incremental
```sql
-- Solo registros modificados recientemente
SELECT no__de_cedula, firstname, lastname, email, 
       numero_asociado, telefono_habitacion, ...
FROM hb_contacts 
WHERE lastmodifieddate > @last_sync_date
  AND no__de_cedula IS NOT NULL
  AND no__de_cedula != ''
ORDER BY lastmodifieddate ASC
```

### 2. Sincronizaci√≥n por Lotes con Verificaci√≥n de C√©dula
```python
# Procesar en lotes optimizados por c√©dula
BATCH_SIZE = 100

def process_batch_by_cedula(sql_records):
    # 1. Extraer todas las c√©dulas del lote
    cedulas = [r['no__de_cedula'] for r in sql_records]
    
    # 2. Buscar contactos existentes en HubSpot (batch)
    existing_contacts = hubspot_api.search_contacts_by_cedulas(cedulas)
    
    # 3. Separar en operaciones INSERT vs UPDATE
    updates = []
    inserts = []
    
    for record in sql_records:
        cedula = record['no__de_cedula']
        if cedula in existing_contacts:
            updates.append({
                'id': existing_contacts[cedula]['id'],
                'properties': map_sql_to_hubspot(record)
            })
        else:
            inserts.append({
                'properties': map_sql_to_hubspot(record)
            })
    
    # 4. Ejecutar operaciones batch
    if updates:
        hubspot_api.batch_update_contacts(updates)
    if inserts:
        hubspot_api.batch_create_contacts(inserts)
```

### 3. Detecci√≥n de Cambios con C√©dula como Clave
```python
# Validaci√≥n espec√≠fica por c√©dula
def needs_update(sql_record, hubspot_contact):
    # Comparar timestamp o campos espec√≠ficos
    sql_modified = sql_record.get('lastmodifieddate')
    hubspot_modified = hubspot_contact.get('hs_lastmodifieddate')
    
    if sql_modified and hubspot_modified:
        return sql_modified > hubspot_modified
    
    # Si no hay timestamps, comparar campos cr√≠ticos
    return has_field_changes(sql_record, hubspot_contact)

def has_field_changes(sql_record, hubspot_contact):
    critical_fields = ['firstname', 'lastname', 'email', 'telefono_habitacion']
    for field in critical_fields:
        sql_value = sql_record.get(field, '').strip()
        hubspot_value = hubspot_contact.get(field, '').strip()
        if sql_value != hubspot_value:
            return True
    return False
```

## üõ°Ô∏è Validaciones y Reglas de Negocio

### üîë Validaciones Cr√≠ticas (Basadas en C√©dula)

1. **üÜî C√âDULA OBLIGATORIA**: Campo `no__de_cedula` es REQUERIDO y √öNICO
   - Formato: Validaci√≥n seg√∫n reglas costarricenses
   - Unicidad: No puede haber duplicados en HubSpot
   - **BLOQUEO**: Sin c√©dula v√°lida, el registro NO se procesa

2. **B√∫squeda Optimizada**: Todos los contactos se buscan/validan por c√©dula
3. **N√∫mero Asociado**: Formato espec√≠fico de la cooperativa  
4. **Campos M√≠nimos**: firstname, lastname, email (despu√©s de la c√©dula)
5. **Beneficiarios**: Suma de porcentajes = 100%

### Validaci√≥n Espec√≠fica de C√©dula Costarricense

```python
import re

def validate_cedula_costarricense(cedula):
    """
    Valida formato de c√©dula costarricense
    Formatos aceptados:
    - F√≠sicas: 1-1234-5678 (9 d√≠gitos)
    - Jur√≠dicas: 3-101-123456 (10 d√≠gitos)
    - DIMEX: 122345678901 (12 d√≠gitos)
    """
    if not cedula:
        return False, "C√©dula no puede estar vac√≠a"
    
    # Limpiar c√©dula (remover espacios y guiones)
    clean_cedula = re.sub(r'[\s\-]', '', str(cedula))
    
    # Validar solo n√∫meros
    if not clean_cedula.isdigit():
        return False, "C√©dula debe contener solo n√∫meros"
    
    # Validar longitud
    if len(clean_cedula) == 9:
        # C√©dula f√≠sica: formato 1-1234-5678
        return True, "C√©dula f√≠sica v√°lida"
    elif len(clean_cedula) == 10:
        # C√©dula jur√≠dica: formato 3-101-123456
        return True, "C√©dula jur√≠dica v√°lida"
    elif len(clean_cedula) == 12:
        # DIMEX: formato 122345678901
        return True, "DIMEX v√°lido"
    else:
        return False, f"Longitud inv√°lida: {len(clean_cedula)} d√≠gitos"

def normalize_cedula(cedula):
    """Normaliza c√©dula para b√∫squeda consistente"""
    if not cedula:
        return None
    return re.sub(r'[\s\-]', '', str(cedula)).strip()
```

### Reglas de Transformaci√≥n con Enfoque en C√©dula

```python
# Pipeline de validaci√≥n centrado en c√©dula
def validate_and_transform_record(sql_record):
    errors = []
    
    # 1. VALIDACI√ìN CR√çTICA: C√©dula
    cedula = sql_record.get('no__de_cedula')
    is_valid, message = validate_cedula_costarricense(cedula)
    if not is_valid:
        errors.append(f"C√âDULA INV√ÅLIDA: {message}")
        return None, errors  # DETENER procesamiento
    
    # 2. Normalizar c√©dula para b√∫squeda
    sql_record['no__de_cedula'] = normalize_cedula(cedula)
    
    # 3. Otras validaciones secundarias
    if not sql_record.get('firstname', '').strip():
        errors.append("Nombre requerido")
    
    if not sql_record.get('lastname', '').strip():
        errors.append("Apellido requerido")
    
    # 4. Transformaciones de datos
    sql_record = normalize_phone_fields(sql_record)
    sql_record = transform_marital_status(sql_record)
    
    return sql_record, errors

# Ejemplo: Normalizaci√≥n de tel√©fonos
def normalize_phone(phone):
    if not phone or phone == '22120000':
        return None
    return clean_phone(phone)

# Ejemplo: Estado civil
MARITAL_STATUS_MAP = {
    '1': 'Soltero',
    '2': 'Casado', 
    '3': 'Divorciado',
    '4': 'Viudo',
    '5': 'Uni√≥n Libre'
}
```

## ‚ö° Optimizaciones de Rendimiento

### 1. Batch Operations
- Usar `/crm/v3/objects/contacts/batch/update`
- M√°ximo 100 registros por batch
- Procesamiento paralelo cuando sea posible

### 2. Caching Inteligente
- Cache de propiedades de HubSpot
- Cache de contactos existentes para evitar b√∫squedas repetidas
- TTL configurable para refresh autom√°tico

### 3. Rate Limiting
- Respetar l√≠mites de API de HubSpot (100 requests/10 seconds)
- Implementar exponential backoff
- Queue de requests con priorizaci√≥n

## üîç Logging y Monitoreo

### Niveles de Log (Centrado en C√©dula)

```python
# Estructura de logging optimizada para c√©dula
{
    "timestamp": "2025-07-30T10:00:00Z",
    "level": "INFO|WARN|ERROR",
    "operation": "INSERT|UPDATE|BATCH|SEARCH",
    "cedula": "123456789",           # üîë Campo cr√≠tico
    "contact_id": "12345",
    "hubspot_id": "67890", 
    "status": "SUCCESS|FAILED|RETRY|SKIPPED",
    "message": "Descripci√≥n detallada",
    "execution_time": "0.5s",
    "batch_id": "batch_001",
    "validation_errors": ["campo1", "campo2"]
}

# Ejemplos espec√≠ficos de log por c√©dula
{
    "level": "INFO",
    "operation": "SEARCH",
    "cedula": "123456789",
    "message": "Contacto encontrado en HubSpot, proceder con UPDATE"
}

{
    "level": "INFO", 
    "operation": "INSERT",
    "cedula": "987654321",
    "hubspot_id": "12345",
    "message": "Nuevo contacto creado exitosamente"
}

{
    "level": "ERROR",
    "operation": "VALIDATION",
    "cedula": "invalid123",
    "status": "SKIPPED",
    "message": "C√©dula inv√°lida: Longitud inv√°lida: 9 d√≠gitos esperados"
}
```

### M√©tricas de Monitoreo (Con Enfoque en C√©dula)

- ‚úÖ **Registros procesados por minuto**
- ‚úÖ **Tasa de √©xito/error por c√©dula**
- ‚úÖ **Tiempo promedio por operaci√≥n** 
- ‚úÖ **Contactos encontrados vs nuevos** (ratio UPDATE/INSERT)
- ‚úÖ **C√©dulas inv√°lidas detectadas**
- ‚úÖ **Uso de API quota**
- ‚úÖ **Registros pendientes en queue**

### Dashboard de Monitoreo en Tiempo Real

```python
# M√©tricas espec√≠ficas del sistema de c√©dula
class SyncMetrics:
    def __init__(self):
        self.total_processed = 0
        self.contacts_updated = 0      # Exist√≠an en HubSpot
        self.contacts_inserted = 0     # Nuevos en HubSpot  
        self.cedulas_invalid = 0       # C√©dulas rechazadas
        self.api_calls_search = 0      # B√∫squedas por c√©dula
        self.api_calls_write = 0       # Escrituras a HubSpot
        
    def get_insert_update_ratio(self):
        total_ops = self.contacts_updated + self.contacts_inserted
        if total_ops == 0:
            return 0, 0
        return (
            (self.contacts_updated / total_ops) * 100,
            (self.contacts_inserted / total_ops) * 100
        )
```

## üö® Manejo de Errores

### Categor√≠as de Error

1. **Errores de Conexi√≥n**
   - SQL Server no disponible
   - HubSpot API no responde
   - **Acci√≥n**: Retry con backoff

2. **Errores de Validaci√≥n**
   - Datos inv√°lidos
   - Campos requeridos faltantes
   - **Acci√≥n**: Log error, continuar con siguiente

3. **Errores de API**
   - Rate limit exceeded
   - Contacto no encontrado
   - **Acci√≥n**: Queue para retry

4. **Errores de Negocio**
   - Duplicados detectados
   - Reglas de validaci√≥n fallidas
   - **Acci√≥n**: Marcaje manual requerido

### Estrategias de Recuperaci√≥n

```python
class RetryStrategy:
    max_retries = 3
    backoff_factor = 2
    retry_statuses = [429, 500, 502, 503, 504]
    
    def should_retry(self, error):
        return error.status_code in self.retry_statuses
```

## üìÅ Estructura de Archivos

### Configuraciones

```yaml
# config.yaml
sql_connection:
  server: "${SQL_SERVER}"
  database: "${SQL_DATABASE}"
  
hubspot:
  batch_size: 100
  rate_limit: 100
  timeout: 30
  
field_mappings:
  contacts:
    numero_asociado: numero_asociado
    no__de_cedula: no__de_cedula
    # ... m√°s mapeos

validation_rules:
  required_fields: [firstname, lastname, email]
  phone_format: "costa_rica"
  cedula_validation: true
```

### Scripts de Ejemplo (Basados en C√©dula)

```python
# Uso b√°sico: Sincronizaci√≥n por c√©dula
from escritura.write_contacts import ContactWriter

writer = ContactWriter()

# 1. Sincronizaci√≥n incremental (solo cambios recientes)
results = writer.sync_from_sql(
    query="""
        SELECT no__de_cedula, firstname, lastname, email, 
               numero_asociado, telefono_habitacion, lastmodifieddate
        FROM hb_contacts 
        WHERE lastmodifieddate > DATEADD(hour, -1, GETDATE())
          AND no__de_cedula IS NOT NULL
          AND no__de_cedula != ''
    """,
    operation="upsert_by_cedula"  # Operaci√≥n espec√≠fica por c√©dula
)

print(f"üìä RESULTADOS DE SINCRONIZACI√ìN:")
print(f"   Total procesados: {results.total}")
print(f"   ‚úÖ Actualizados: {results.updated}")  # Exist√≠an en HubSpot
print(f"   ‚ûï Insertados: {results.inserted}")   # Nuevos en HubSpot
print(f"   ‚ùå Errores: {results.errors}")
print(f"   ‚ö†Ô∏è  C√©dulas inv√°lidas: {results.invalid_cedulas}")

# 2. Sincronizaci√≥n de un contacto espec√≠fico por c√©dula
single_result = writer.sync_contact_by_cedula("123456789")
if single_result.success:
    print(f"‚úÖ Contacto con c√©dula 123456789 sincronizado")
    print(f"   Operaci√≥n: {single_result.operation}")  # INSERT o UPDATE
    print(f"   HubSpot ID: {single_result.hubspot_id}")
else:
    print(f"‚ùå Error: {single_result.error_message}")

# 3. Ejemplo de uso avanzado con filtros
results = writer.sync_from_sql(
    query="""
        SELECT * FROM hb_contacts 
        WHERE provincia = 'San Jos√©'
          AND no__de_cedula IS NOT NULL
        ORDER BY lastmodifieddate DESC
    """,
    operation="upsert_by_cedula",
    batch_size=50,  # Procesar en lotes de 50
    validate_before_sync=True  # Validar antes de enviar
)

# 4. Manejo detallado de resultados
for error in results.detailed_errors:
    print(f"‚ùå C√©dula {error.cedula}: {error.message}")

for success in results.detailed_success:
    operation = "üìù Actualizado" if success.was_update else "‚ûï Creado"
    print(f"‚úÖ {operation}: {success.cedula} ‚Üí HubSpot ID: {success.hubspot_id}")
```

### Ejemplo de Configuraci√≥n Espec√≠fica

```python
# Configuraci√≥n personalizada para c√©dula
writer = ContactWriter(config={
    'cedula_validation': {
        'strict_mode': True,           # Rechazar c√©dulas inv√°lidas
        'normalize_format': True,      # Limpiar guiones y espacios
        'validate_checksum': False     # Para c√©dulas con d√≠gito verificador
    },
    'search_strategy': {
        'field': 'no__de_cedula',      # Campo de b√∫squeda principal
        'exact_match': True,           # B√∫squeda exacta
        'case_sensitive': False        # No sensible a may√∫sculas
    },
    'operation_priority': {
        'prefer_update': True,         # Preferir UPDATE sobre INSERT
        'create_if_missing': True      # Crear si no existe
    }
})
```

## üß™ Testing y Calidad

### Test Cases Cr√≠ticos (Basados en C√©dula)

1. **‚úÖ Test de Inserci√≥n por C√©dula**
   - **Escenario**: C√©dula `123456789` existe en SQL pero no en HubSpot
   - **Acci√≥n**: `writer.sync_contact_by_cedula("123456789")`
   - **Resultado Esperado**: `INSERT` exitoso, retorna HubSpot ID nuevo

2. **üìù Test de Actualizaci√≥n por C√©dula**
   - **Escenario**: C√©dula `987654321` existe en ambos sistemas
   - **Acci√≥n**: Modificar datos en SQL, ejecutar sync
   - **Resultado Esperado**: `UPDATE` exitoso, datos actualizados en HubSpot

3. **‚ùå Test de Validaci√≥n de C√©dula**
   - **Escenario**: C√©dula inv√°lida `invalid123`
   - **Acci√≥n**: Intentar sincronizaci√≥n
   - **Resultado Esperado**: Rechazo inmediato, error descriptivo

4. **üì¶ Test de Batch por C√©dula**
   - **Escenario**: 1000 registros con c√©dulas mixtas (algunas existen, otras no)
   - **Acci√≥n**: Batch processing
   - **Resultado Esperado**: Separaci√≥n correcta en UPDATEs/INSERTs

5. **üîÑ Test de Recuperaci√≥n de Errores**
   - **Escenario**: API de HubSpot retorna error 429 (rate limit)
   - **Acci√≥n**: Verificar retry autom√°tico
   - **Resultado Esperado**: Reintentos con backoff exponencial

6. **üîç Test de B√∫squeda por C√©dula**
   - **Escenario**: C√©dula con diferentes formatos (`1-2345-6789` vs `123456789`)
   - **Acci√≥n**: B√∫squeda normalizada
   - **Resultado Esperado**: Encuentra contacto independiente del formato

### Casos de Prueba Espec√≠ficos

```python
import pytest
from escritura.write_contacts import ContactWriter

class TestCedulaSync:
    
    def test_insert_new_cedula(self):
        """Test inserci√≥n de contacto con c√©dula nueva"""
        writer = ContactWriter()
        
        # Mock: C√©dula no existe en HubSpot
        mock_sql_record = {
            'no__de_cedula': '123456789',
            'firstname': 'Juan',
            'lastname': 'P√©rez',
            'email': 'juan@test.com'
        }
        
        result = writer.sync_contact_by_cedula('123456789')
        
        assert result.operation == 'INSERT'
        assert result.success == True
        assert result.hubspot_id is not None
    
    def test_update_existing_cedula(self):
        """Test actualizaci√≥n de contacto existente"""
        writer = ContactWriter()
        
        # Mock: C√©dula existe en HubSpot
        result = writer.sync_contact_by_cedula('987654321')
        
        assert result.operation == 'UPDATE'
        assert result.success == True
        assert result.hubspot_id is not None
    
    def test_invalid_cedula_rejection(self):
        """Test rechazo de c√©dula inv√°lida"""
        writer = ContactWriter()
        
        result = writer.sync_contact_by_cedula('invalid123')
        
        assert result.success == False
        assert 'C√©dula inv√°lida' in result.error_message
    
    def test_batch_mixed_cedulas(self):
        """Test batch con c√©dulas mixtas"""
        writer = ContactWriter()
        
        sql_query = """
            SELECT no__de_cedula, firstname, lastname, email
            FROM test_contacts 
            WHERE batch_test = 1
        """
        
        results = writer.sync_from_sql(sql_query)
        
        assert results.total > 0
        assert results.updated + results.inserted == results.total - results.errors
        assert results.invalid_cedulas >= 0
```

### Ambientes de Testing

- **Development**: HubSpot Sandbox + SQL Test DB
- **Staging**: HubSpot Sandbox + SQL Staging
- **Production**: HubSpot Production + SQL Production

## üìÖ Plan de Implementaci√≥n

### Fase 1: Base (Semana 1)
- ‚úÖ Configuraci√≥n de proyecto
- ‚úÖ SQL Reader b√°sico
- ‚úÖ HubSpot Writer b√°sico
- ‚úÖ Mapeo de campos core

### Fase 2: L√≥gica de Negocio (Semana 2)
- ‚úÖ Data Validator
- ‚úÖ Field Mapper completo
- ‚úÖ Batch Processor
- ‚úÖ Error Handler

### Fase 3: Optimizaci√≥n (Semana 3)
- ‚úÖ Caching system
- ‚úÖ Rate limiting
- ‚úÖ Performance tuning
- ‚úÖ Comprehensive logging

### Fase 4: Testing y Deploy (Semana 4)
- ‚úÖ Unit tests
- ‚úÖ Integration tests
- ‚úÖ Performance tests
- ‚úÖ Production deployment

## üîê Consideraciones de Seguridad

### Datos Sensibles
- Nunca loggear passwords o tokens
- Encriptar datos en tr√°nsito
- Usar variables de entorno para credenciales

### Acceso y Permisos
- Principio de menor privilegio
- Auditor√≠a de accesos
- Rotaci√≥n regular de tokens

## üìà M√©tricas de √âxito

### KPIs T√©cnicos
- **Throughput**: > 1000 contactos/hora
- **Accuracy**: > 99.5% de datos correctos
- **Availability**: > 99.9% uptime
- **Performance**: < 2s promedio por batch

### KPIs de Negocio
- **Data Freshness**: < 1 hora de lag
- **Error Rate**: < 0.1% de fallos
- **Coverage**: 100% de campos cr√≠ticos
- **Compliance**: 100% adherencia a reglas

## üîÑ Mantenimiento y Evoluci√≥n

### Monitoreo Continuo
- Dashboards en tiempo real
- Alertas autom√°ticas
- Reports semanales de performance

### Evoluci√≥n del Sistema
- Nuevos campos seg√∫n necesidades
- Optimizaciones de performance
- Integraci√≥n con otros sistemas

---

## üìù Notas de Desarrollo

### Tecnolog√≠as Utilizadas
- **Python 3.13+**: Lenguaje principal
- **pyodbc**: Conexi√≥n SQL Server
- **requests**: HubSpot API calls
- **pydantic**: Validaci√≥n de datos
- **asyncio**: Operaciones as√≠ncronas
- **pytest**: Testing framework

### Consideraciones Especiales
- Manejo de timezone (UTC vs local)
- Caracteres especiales en nombres
- Formatos de fecha regionales
- **Validaciones espec√≠ficas de Costa Rica**
- **üîë C√âDULA como campo √∫nico de validaci√≥n**

---

## üéØ RESUMEN EJECUTIVO: Especificaci√≥n de C√©dula √önica

### ‚ö° Decisi√≥n T√©cnica Principal
**El sistema utilizar√° EXCLUSIVAMENTE el campo `no__de_cedula` como criterio √∫nico para determinar operaciones de sincronizaci√≥n:**

### üîÑ Flujo Simplificado
```
1. ‚û°Ô∏è  Leer registro de SQL Server
2. üîç Buscar en HubSpot por no__de_cedula
3. ‚ùì ¬øExiste?
   ‚îú‚îÄ‚îÄ ‚úÖ S√ç  ‚Üí UPDATE (actualizar datos)
   ‚îî‚îÄ‚îÄ ‚ùå NO  ‚Üí INSERT (crear nuevo)
4. üìù Log resultado por c√©dula
```

### üéØ Beneficios de esta Aproximaci√≥n
- **‚úÖ Simplicidad**: Un solo campo de validaci√≥n
- **‚úÖ Consistencia**: Sin ambig√ºedad en la l√≥gica
- **‚úÖ Performance**: B√∫squedas optimizadas por c√©dula
- **‚úÖ Auditor√≠a**: Trazabilidad clara por c√©dula
- **‚úÖ Escalabilidad**: Batch operations eficientes

### üö´ Campos NO Utilizados para Validaci√≥n
- ‚ùå `email` (puede cambiar)
- ‚ùå `numero_asociado` (puede cambiar)
- ‚ùå `firstname + lastname` (pueden cambiar)
- ‚ùå Combinaciones de campos

### ‚ö†Ô∏è Requisitos Cr√≠ticos
1. **Campo `no__de_cedula` OBLIGATORIO** en SQL
2. **Validaci√≥n de formato costarricense** antes de procesar
3. **Normalizaci√≥n de formato** para b√∫squedas consistentes
4. **Manejo de errores** para c√©dulas inv√°lidas

---

**Autor**: Ing. Jos√© R√≠ler Sol√≥rzano Campos  
**Fecha**: 30 de julio de 2025  
**Versi√≥n**: 1.1 - Especificaci√≥n de C√©dula √önica  
**Estado**: Documentaci√≥n Actualizada
